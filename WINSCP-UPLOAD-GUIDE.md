# 📤 WinSCP使用 - .envファイルアップロード手順

## 🎯 WinSCPでの.envアップロード（推奨方法）

### 1. **WinSCP接続設定**

#### A. 新しいセッション作成
```
1. WinSCPを起動
2. 「新しいサイト」をクリック
3. 以下の設定を入力:
```

#### B. 接続情報入力
```
転送プロトコル: SFTP
ホスト名: your-server.com (あなたのサーバーのドメインまたはIP)
ポート番号: 22 (デフォルト) または 2222 (カスタムポートの場合)
ユーザー名: your-username (サーバーのユーザー名)
パスワード: your-password (サーバーのパスワード)
```

#### C. 秘密鍵使用の場合
```
1. 「高度な設定」をクリック
2. 「SSH」→「認証」を選択
3. 「秘密鍵ファイル」で.ppkファイルを選択
4. 「OK」をクリック
```

### 2. **サーバーに接続**

```
1. 「ログイン」ボタンをクリック
2. 初回接続時はホストキーの確認ダイアログが表示
3. 「はい」をクリックして接続
4. 接続成功後、ファイルマネージャーが表示される
```

### 3. **目的ディレクトリに移動**

#### A. リモート側（右側）の操作
```
1. リモートディレクトリ（右側パネル）で以下のパスに移動:
   /var/www/html/api/
   
2. パスがない場合は以下も確認:
   /home/username/public_html/api/
   /public_html/api/
   
3. 上部のアドレスバーに直接入力も可能
```

#### B. ローカル側（左側）の操作
```
1. ローカルディレクトリ（左側パネル）で以下に移動:
   C:\Users\uketp\Aivis-chan-bot-web\
   
2. .envファイルが表示されることを確認
```

### 4. **.envファイルのアップロード**

#### A. ドラッグ&ドロップ方式
```
1. 左側パネルの.envファイルを選択
2. 右側パネルの/var/www/html/api/フォルダにドラッグ
3. 「転送設定」ダイアログが表示される
4. 「OK」をクリックしてアップロード開始
```

#### B. 右クリックメニュー方式
```
1. 左側パネルの.envファイルを右クリック
2. 「アップロード」を選択
3. 転送先ディレクトリを確認
4. 「OK」をクリック
```

#### C. F5キー方式
```
1. 左側パネルの.envファイルを選択
2. F5キーを押す
3. 転送先を確認して「OK」をクリック
```

### 5. **転送設定の確認**

#### アップロード時の推奨設定
```
転送モード: Binary（バイナリ）
上書き: はい（上書きする）
権限の保持: いいえ
タイムスタンプの保持: いいえ
```

### 6. **アップロード後の権限設定**

#### A. WinSCP内での権限変更
```
1. 右側パネルの.envファイルを右クリック
2. 「プロパティ」を選択
3. 権限設定:
   - 所有者: 読み取り✓ 書き込み✓ 実行✗
   - グループ: すべて✗
   - その他: すべて✗
4. 「OK」をクリック
```

#### B. 手動権限設定（数値）
```
権限の8進数値: 600
- Owner: rw- (6)
- Group: --- (0)  
- Other: --- (0)
```

### 7. **.htaccessファイルの作成**

#### A. WinSCP内でファイル作成
```
1. 右側パネル（/var/www/html/api/）で右クリック
2. 「新規」→「ファイル」を選択
3. ファイル名: .htaccess
4. 「OK」をクリック
```

#### B. .htaccessの内容編集
```apache
# WinSCPのエディタで以下を入力:
<Files ".env">
    Require all denied
</Files>

<FilesMatch "\.(env|log|key|pem)$">
    Require all denied
</FilesMatch>

Header always set Access-Control-Allow-Origin "https://aivis-chan-bot.com"
Header always set Access-Control-Allow-Methods "GET, POST, OPTIONS"
Header always set Access-Control-Allow-Headers "Content-Type, Authorization"
```

### 8. **アップロード確認**

#### A. ファイル存在確認
```
1. 右側パネルで.envファイルが表示されることを確認
2. ファイルサイズが0より大きいことを確認
3. 権限が600になっていることを確認
```

#### B. 内容確認（必要に応じて）
```
1. .envファイルをダブルクリック
2. WinSCPエディタで内容を確認
3. Botトークンが正しく設定されていることを確認
4. 編集しない場合は「キャンセル」で閉じる
```

## 🔧 アップロード後の作業

### 1. **サーバーでのNode.js設定**

コマンドプロンプトまたはWinSCPのターミナル機能で:
```bash
# APIディレクトリに移動
cd /var/www/html/api/

# 依存関係インストール
npm install

# PM2でサービス起動
npm install -g pm2
pm2 start bot-stats-server.js --name "aivis-api"
pm2 startup
pm2 save
```

### 2. **動作確認**

#### A. API動作テスト
```bash
# ヘルスチェック
curl https://your-domain.com/api/health

# Bot統計取得
curl https://your-domain.com/api/bot-stats/1333819940645638154
```

#### B. ウェブサイト確認
```
1. https://your-domain.com にアクセス
2. メインページの統計情報が表示されることを確認
3. 数値がアニメーションで更新されることを確認
```

### 3. **セキュリティ確認**

```bash
# .envファイルへの直接アクセスが禁止されていることを確認
curl https://your-domain.com/api/.env
# → 403 Forbidden が返ることを確認
```

## 🎯 WinSCPのメリット

✅ **視覚的操作** - ファイルエクスプローラーのような直感的な操作  
✅ **ドラッグ&ドロップ** - 簡単なファイル転送  
✅ **権限設定** - GUI上で簡単に権限変更可能  
✅ **内蔵エディタ** - ファイル編集がその場で可能  
✅ **転送ログ** - アップロード状況の確認が簡単  

## 🚨 注意事項

⚠️ **パスワード保存** - WinSCPでパスワードを保存する場合は、PCのセキュリティに注意  
⚠️ **ファイアウォール** - 企業ネットワークではSFTP(22番ポート)がブロックされている場合がある  
⚠️ **権限設定** - .envファイルの権限は必ず600に設定すること  

これでWinSCPを使った安全な.envアップロードが完了します！🚀
